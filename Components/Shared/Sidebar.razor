@using Bin_Blog.Web.Data
@using Bin_Blog.Web.Models
@using Bin_Blog.Web.Services
@inject BlogService BlogService
@inject IJSRuntime JS

<div class="sidebar">
    <div class="card profile-card">
        <div style="margin-top: 15px; text-align: center;">
            <a href="/about" style="color: var(--accent-color); text-decoration: none; font-size: 0.9rem; border-bottom: 1px solid var(--accent-color);">
                了解更多关于我 &rarr;
            </a>
        </div>
        <div style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:10px;">
            <img src="@GetAvatarUrl()"
                 alt="@_displayName"
                 style="width:72px; height:72px; border-radius:50%; object-fit:cover; border:1px solid rgba(0,0,0,0.06);"
                 onerror="this.src='/images/default-avatar.png'" />

            <h3 style="margin:0;">@_displayName</h3>
        </div>

        @if (!string.IsNullOrWhiteSpace(_bio))
        {
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top:10px;">
                @_bio
            </p>
        }
        else
        {
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top:10px;">
                @if (_isLoggedIn)
                {
                    <span>这个人很懒，还没有填写简介。</span>
                }
                else
                {
                    <>
                        <span>全栈开发者 / 极简主义者。</span>
                        <br />
                        <span>分享代码、设计与生活的思考。</span>
                    </>
                }
            </p>
        }
    </div>

    <div class="card">
        <h4 style="margin-bottom: 15px;">公告</h4>
        @if (Announcements.Any())
        {
            <ul style="list-style:none; padding-left:0; margin:0;">
                @foreach (var a in Announcements)
                {
                    <li style="margin-bottom:10px;">
                        <div style="display:flex; gap:8px; align-items:baseline;">
                            @if (a.IsPinned)
                            {
                                <span style="font-size:0.8rem; color:var(--accent-color);">置顶</span>
                            }
                            <span style="color:var(--text-primary); font-size:0.95rem; font-weight:600;">
                                @a.Title
                            </span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(a.Content))
                        {
                            <div style="font-size:0.85rem; color:var(--text-secondary); margin-top:4px;">
                                @a.Content
                            </div>
                        }
                        <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:4px;">
                            @a.PublishDate.ToLocalTime().ToString("yyyy-MM-dd")
                        </div>
                    </li>
                }
            </ul>
        }
        else
        {
            <p style="font-size:0.9rem; color:var(--text-secondary); margin:0;">
                暂无公告
            </p>
        }
    </div>

    <div class="card">
        <h4 style="margin-bottom: 15px;">热门文章</h4>
        @if (PopularPosts.Any())
        {
            <ul style="list-style:none; padding-left:0; margin:0;">
                @foreach (var post in PopularPosts)
                {
                    <li style="margin-bottom:10px;">
                        <a href="/post/@post.Id"
                           style="text-decoration:none; color:var(--text-primary); font-size:0.95rem;">
                            @post.Title
                        </a>
                        <div style="font-size:0.8rem; color:var(--text-secondary);">
                            @post.PublishDate.ToString("yyyy-MM-dd")
                        </div>
                    </li>
                }
            </ul>
        }
        else
        {
            <p style="font-size:0.9rem; color:var(--text-secondary); margin:0;">
                暂无文章
            </p>
        }
    </div>
</div>

@code {
    private List<BlogPost> PopularPosts = new();
    private List<Announcement> Announcements = new();

    private bool _isLoggedIn;
    private string _displayName = "Alex 的博客";
    private string? _avatarUrl;
    private string? _bio;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadCurrentUserForSidebarAsync();

            // 获取所有文章（防御性编程，避免空引用）
            var posts = await BlogService.GetPostsAsync() ?? new List<BlogPost>();

            // 简单示例：按发布时间倒序取前 5 篇作为热门文章
            PopularPosts = posts
                .OrderByDescending(p => p.PublishDate)
                .Take(5)
                .ToList();

            Announcements = await BlogService.GetAnnouncementsAsync(5);
        }
        catch (Exception)
        {
            // 如果这里出错，不让整个应用崩溃，只是侧边栏不显示数据
            PopularPosts = new List<BlogPost>();
            Announcements = new List<Announcement>();
            _isLoggedIn = false;
            _displayName = "Alex 的博客";
            _avatarUrl = null;
            _bio = null;
        }
    }

    private string GetAvatarUrl()
        => string.IsNullOrWhiteSpace(_avatarUrl) ? "/images/default-avatar.png" : _avatarUrl!;

    private async Task LoadCurrentUserForSidebarAsync()
    {
        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
            var userName = await JS.InvokeAsync<string>("localStorage.getItem", "userName");
            var nickName = await JS.InvokeAsync<string>("localStorage.getItem", "nickName");

            _isLoggedIn = !string.IsNullOrWhiteSpace(token) && !string.IsNullOrWhiteSpace(userName);
            if (!_isLoggedIn)
            {
                _displayName = "Alex 的博客";
                _avatarUrl = null;
                _bio = null;
                return;
            }

            _displayName = string.IsNullOrWhiteSpace(nickName) ? userName! : nickName!;

            var user = await BlogService.GetUserByNameAsync(userName!);
            if (user != null)
            {
                _avatarUrl = user.AvatarUrl;
                _bio = user.Bio;
            }
        }
        catch
        {
            _isLoggedIn = false;
            _displayName = "Alex 的博客";
            _avatarUrl = null;
            _bio = null;
        }
    }
}