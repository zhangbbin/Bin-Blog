@rendermode InteractiveServer
@using Bin_Blog.Web.Data
@using Bin_Blog.Web.Models
@using Bin_Blog.Web.Services
@inject BlogService BlogService

<div class="sidebar">
    <div class="card profile-card">
        <div style="margin-top: 15px; text-align: center;">
            <a href="/about" style="color: var(--accent-color); text-decoration: none; font-size: 0.9rem; border-bottom: 1px solid var(--accent-color);">
                了解更多关于我 &rarr;
            </a>
        </div>
        @if (_isLoggedIn)
        {
            <div style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:10px;">
                <img src="@GetAvatarUrl()"
                     alt="@_nickName"
                     style="width:72px; height:72px; border-radius:50%; object-fit:cover; border:1px solid rgba(0,0,0,0.06);"
                     onerror="this.src='/images/default-avatar.png'" />

                <h3 style="margin:0;">@_nickName</h3>
            </div>
            @if (!string.IsNullOrWhiteSpace(_bioTruncated))
            {
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top:8px; text-align:center;">
                    @_bioTruncated
                </p>
            }
        }
        else
        {
            <div class="profile-img"></div>
            <h3>Alex 的博客</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                全栈开发者 / 极简主义者。
                <br />
                分享代码、设计与生活的思考。
            </p>
        }
    </div>

    <div class="card">
        <h4 style="margin-bottom: 15px;">公告</h4>
        @if (Announcements.Any())
        {
            <ul style="list-style:none; padding-left:0; margin:0;">
                @foreach (var a in Announcements)
                {
                    <li style="margin-bottom:10px;">
                        <div style="display:flex; gap:8px; align-items:baseline;">
                            @if (a.IsPinned)
                            {
                                <span style="font-size:0.8rem; color:var(--accent-color);">置顶</span>
                            }
                            <span style="color:var(--text-primary); font-size:0.95rem; font-weight:600;">
                                @a.Title
                            </span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(a.Content))
                        {
                            <div style="font-size:0.85rem; color:var(--text-secondary); margin-top:4px;">
                                @a.Content
                            </div>
                        }
                        <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:4px;">
                            @a.PublishDate.ToLocalTime().ToString("yyyy-MM-dd")
                        </div>
                    </li>
                }
            </ul>
        }
        else
        {
            <p style="font-size:0.9rem; color:var(--text-secondary); margin:0;">
                暂无公告
            </p>
        }
    </div>

    <div class="card">
        <h4 style="margin-bottom: 15px;">热门文章</h4>
        @if (PopularPosts.Any())
        {
            <ul style="list-style:none; padding-left:0; margin:0;">
                @foreach (var post in PopularPosts)
                {
                    <li style="margin-bottom:10px;">
                        <a href="/post/@post.Id"
                           style="text-decoration:none; color:var(--text-primary); font-size:0.95rem;">
                            @post.Title
                        </a>
                        <div style="font-size:0.8rem; color:var(--text-secondary);">
                            @post.PublishDate.ToString("yyyy-MM-dd")
                        </div>
                    </li>
                }
            </ul>
        }
        else
        {
            <p style="font-size:0.9rem; color:var(--text-secondary); margin:0;">
                暂无文章
            </p>
        }
    </div>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private List<BlogPost> PopularPosts = new();
    private List<Announcement> Announcements = new();

    private bool _isLoggedIn;
    private string _nickName = string.Empty;
    private string? _avatarUrl;
    private string? _bioTruncated;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var posts = await BlogService.GetPostsAsync() ?? new List<BlogPost>();
            PopularPosts = posts
                .OrderByDescending(p => p.PublishDate)
                .Take(5)
                .ToList();

            Announcements = await BlogService.GetAnnouncementsAsync(5);
        }
        catch
        {
            PopularPosts = new List<BlogPost>();
            Announcements = new List<Announcement>();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadCurrentUserForSidebarAsync();
    }

    private string GetAvatarUrl()
        => string.IsNullOrWhiteSpace(_avatarUrl) ? "/images/default-avatar.png" : _avatarUrl!;

    private async Task LoadCurrentUserForSidebarAsync()
    {
        try
        {
            if (AuthState == null)
            {
                ResetUserState();
                return;
            }

            var authState = await AuthState;
            var principal = authState.User;

            _isLoggedIn = principal?.Identity?.IsAuthenticated == true;
            if (!_isLoggedIn)
            {
                ResetUserState();
                return;
            }

            var loginUserName = principal!.Identity?.Name;
            if (string.IsNullOrWhiteSpace(loginUserName))
            {
                ResetUserState();
                return;
            }

            var user = await BlogService.GetUserByNameAsync(loginUserName);
            if (user != null)
            {
                _nickName = string.IsNullOrWhiteSpace(user.NickName) ? user.UserName : user.NickName;
                _avatarUrl = user.AvatarUrl;
                _bioTruncated = TruncateBio(user.Bio, 60);
            }
            else
            {
                _nickName = loginUserName;
                _avatarUrl = null;
                _bioTruncated = null;
            }
        }
        catch
        {
            ResetUserState();
        }
    }

    private void ResetUserState()
    {
        _isLoggedIn = false;
        _nickName = string.Empty;
        _avatarUrl = null;
        _bioTruncated = null;
    }

    private static string? TruncateBio(string? bio, int maxLength)
    {
        if (string.IsNullOrWhiteSpace(bio))
            return null;

        var trimmed = bio.Trim();
        return trimmed.Length <= maxLength ? trimmed : string.Concat(trimmed.AsSpan(0, maxLength), "...");
    }
}