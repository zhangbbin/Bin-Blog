@page "/write"
@rendermode InteractiveServer
@using Bin_Blog.Web.Data
@using Bin_Blog.Web.Services
@using Markdig
@inject BlogService BlogService
@inject IJSRuntime JS
@inject NavigationManager Nav

<PageTitle>写文章 - Bin's Blog</PageTitle>

<div class="card fade-in">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom: 16px;">
        <button type="button" class="write-back-btn" title="返回" @onclick="GoBack">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8" />
            </svg>
        </button>
        <h2 style="margin:0;">写文章</h2>
    </div>

    @if (!IsLoggedIn)
    {
        <p style="color:var(--text-secondary); margin:0;">
            请先登录后再写文章。
        </p>
    }
    else
    {
        <div style="display:grid; grid-template-columns: 1fr; gap: 14px;">
            <div>
                <label style="display:block; font-size:0.9rem; color:var(--text-secondary); margin-bottom:6px;">标题</label>
                <input class="form-control" @bind="Model.Title" placeholder="请输入文章标题" />
            </div>

            <div>
                <label style="display:block; font-size:0.9rem; color:var(--text-secondary); margin-bottom:6px;">分类</label>
                <select class="form-control" @bind="Model.CategoryId">
                    <option value="">未分类</option>
                    @foreach (var c in Categories)
                    {
                        <option value="@c.Id">@c.Name</option>
                    }
                </select>
            </div>

            <div>
                <label style="display:block; font-size:0.9rem; color:var(--text-secondary); margin-bottom:6px;">内容（Markdown）</label>
                <textarea class="form-control" style="min-height: 240px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"
                          @bind="Model.Content"
                          @bind:event="oninput"></textarea>
            </div>

            <div>
                <label style="display:block; font-size:0.9rem; color:var(--text-secondary); margin-bottom:6px;">预览</label>
                <div class="markdown-body" style="border:1px solid var(--border-color, #eee); border-radius:8px; padding:12px; background: var(--bg-color);">
                    @((MarkupString)PreviewHtml)
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(Error))
            {
                <div style="color:#c33;">@Error</div>
            }

            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="auth-link-btn" @onclick="Cancel" type="button">取消</button>
                <button class="auth-submit-btn" style="width:auto; padding:10px 16px;" @onclick="Publish" disabled="@IsSubmitting" type="button">
                    @(IsSubmitting ? "发布中..." : "发布")
                </button>
            </div>
        </div>
    }
</div>

@code {
    private bool IsLoggedIn;
    private string _loginUserName = string.Empty;
    private bool IsSubmitting;
    private string? Error;

    private List<Category> Categories = new();

    private WritePostModel Model = new();

    private string PreviewHtml
    {
        get
        {
            var pipeline = new MarkdownPipelineBuilder().UseAdvancedExtensions().Build();
            return Markdown.ToHtml(Model.Content ?? string.Empty, pipeline);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Categories = await BlogService.GetCategoriesAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
        var userName = await JS.InvokeAsync<string>("localStorage.getItem", "userName");
        IsLoggedIn = !string.IsNullOrWhiteSpace(token) && !string.IsNullOrWhiteSpace(userName);
        _loginUserName = userName ?? string.Empty;
        StateHasChanged();
    }

    private async Task GoBack()
    {
        try
        {
            await JS.InvokeVoidAsync("history.back");
        }
        catch
        {
            Nav.NavigateTo("/");
        }
    }

    private void Cancel()
    {
        Nav.NavigateTo("/");
    }

    private async Task Publish()
    {
        Error = null;

        if (string.IsNullOrWhiteSpace(Model.Title))
        {
            Error = "标题不能为空。";
            return;
        }

        if (string.IsNullOrWhiteSpace(Model.Content))
        {
            Error = "内容不能为空。";
            return;
        }

        if (string.IsNullOrWhiteSpace(_loginUserName))
        {
            Error = "未获取到登录用户信息，请重新登录。";
            return;
        }

        IsSubmitting = true;
        try
        {
            var postId = await BlogService.CreatePostAsync(_loginUserName, Model.Title, Model.Content, Model.CategoryId);
            if (postId == null)
            {
                Error = "发布失败：未找到作者信息。";
                return;
            }

            Nav.NavigateTo($"/post/{postId}");
        }
        catch (Exception ex)
        {
            Error = "发布失败：" + ex.Message;
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private sealed class WritePostModel
    {
        public string Title { get; set; } = string.Empty;
        public int? CategoryId { get; set; }
        public string Content { get; set; } = string.Empty;
    }
}
