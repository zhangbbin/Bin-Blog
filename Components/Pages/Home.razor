@page "/"
@rendermode InteractiveServer
@using Bin_Blog.Web.Services
@using Bin_Blog.Web.Data
@using Bin_Blog.Components.Shared
@inject BlogService BlogService

<PageTitle>首页 - Bin's Blog</PageTitle>

<div class="home-container fade-in">
    @* 1. 插入分类栏 *@
    <CategoryBar OnCategorySelected="FilterByCategory" OnSearch="FilterBySearch" />

    @* 2. 文章列表 *@
    <div class="posts-list">
        @if (isLoading)
        {
            <div class="text-center mt-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p>加载文章中...</p>
            </div>
        }
        else if (posts == null || !posts.Any())
        {
            <div class="empty-state text-center mt-5">
                <p style="color:#999;">暂无相关文章。</p>
            </div>
        }
        else
        {
            @foreach (var post in posts)
            {
                <div class="post-card fade-in">
                    <h2 class="post-title">
                        <a href="/post/@post.Id">@post.Title</a>
                    </h2>
                    <div class="post-meta">
                        <span>@post.PublishDate.ToString("yyyy-MM-dd")</span>

                        @if (post.Category != null)
                        {
                            <span class="meta-separator">·</span>
                            <span class="meta-category">@post.Category.Name</span>
                        }
                    </div>
                    <p class="post-preview">
                        @GetPreview(post.Content)
                    </p>
                    <a href="/post/@post.Id" class="read-more">阅读全文 &rarr;</a>
                </div>
                <hr class="post-divider" />
            }
        }
    </div>
</div>

@code {
    private List<BlogPost> posts = new();
    private bool isLoading = true;

    // 当前筛选状态
    private int? currentCategoryId;
    private string? currentSearchKeyword;

    protected override async Task OnInitializedAsync()
    {
        await LoadPosts();
    }

    private async Task LoadPosts()
    {
        isLoading = true;
        // 调用 Service 新增的带参数方法
        posts = await BlogService.GetPostsAsync(currentCategoryId, currentSearchKeyword);
        isLoading = false;
        // 强制刷新 UI (在交互模式下有时需要)
        StateHasChanged();
    }

    // 处理分类点击
    private async Task FilterByCategory(int? categoryId)
    {
        currentCategoryId = categoryId;
        currentSearchKeyword = null; // 切换分类时清空搜索？看你需求，这里先清空
        await LoadPosts();
    }

    // 处理搜索
    private async Task FilterBySearch(string keyword)
    {
        currentSearchKeyword = keyword;
        // 搜索时是否保留分类筛选？这里保留，实现“在当前分类下搜索”
        // 如果想全站搜索，可以设置 currentCategoryId = null;
        await LoadPosts();
    }

    private string GetPreview(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        // 简单去除 Markdown 符号 (粗糙版)
        var plain = System.Text.RegularExpressions.Regex.Replace(content, "[#*`>]", "");
        return plain.Length > 150 ? plain.Substring(0, 150) + "..." : plain;
    }
}