@page "/admin/edit"
@page "/admin/edit/{PostId:int}"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Bin_Blog.Web.Data
@using Bin_Blog.Web.Services
@using Markdig
@inject AdminBlogService AdminService
@inject BlogService BlogService
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>@(IsNew ? "新建文章" : "编辑文章") - Bin's Blog</PageTitle>

<AuthorizeView Roles="Admin,Author">
    <Authorized Context="authContext">
        <div class="admin-container fade-in">
            <div class="admin-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button type="button" class="write-back-btn" title="返回" @onclick="GoBack">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8" />
                        </svg>
                    </button>
                    <h2 style="margin:0;">@(IsNew ? "新建文章" : "编辑文章")</h2>
                </div>
                @if (_lastAutoSave != null)
                {
                    <span style="font-size:0.8rem; color:var(--text-secondary);">
                        自动保存于 @_lastAutoSave.Value.ToString("HH:mm:ss")
                    </span>
                }
            </div>

            @if (!string.IsNullOrWhiteSpace(_error))
            {
                <div class="auth-error" style="margin-bottom:16px;">@_error</div>
            }
            @if (!string.IsNullOrWhiteSpace(_success))
            {
                <div class="auth-success" style="margin-bottom:16px;">@_success</div>
            }

            <div class="admin-editor-grid">
                @* 左侧：编辑区 *@
                <div class="admin-editor-main">
                    <div class="form-group">
                        <label class="admin-label">标题 <span style="color:#c33;">*</span></label>
                        <input type="text" class="form-control" @bind="_model.Title" placeholder="请输入文章标题（最多200字）" maxlength="200" />
                    </div>

                    <div class="form-group">
                        <label class="admin-label">内容（Markdown） <span style="color:#c33;">*</span></label>
                        <textarea class="form-control admin-md-editor"
                                  @bind="_model.Content"
                                  @bind:event="oninput"
                                  placeholder="开始写作...&#10;&#10;支持 Markdown 语法"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="admin-label">
                            预览
                            <button type="button" class="admin-toggle-preview" @onclick="() => _showPreview = !_showPreview">
                                @(_showPreview ? "收起" : "展开")
                            </button>
                        </label>
                        @if (_showPreview)
                        {
                            <div class="markdown-body admin-preview-box">
                                @((MarkupString)PreviewHtml)
                            </div>
                        }
                    </div>
                </div>

                @* 右侧：属性面板 *@
                <div class="admin-editor-sidebar">
                    <div class="card" style="padding:16px;">
                        <h4 style="margin:0 0 12px 0; font-size:0.95rem;">文章属性</h4>

                        <div class="form-group">
                            <label class="admin-label">摘要</label>
                            <textarea class="form-control" @bind="_model.Summary" rows="2" placeholder="可选，文章列表简介"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="admin-label">分类</label>
                            <select class="form-control" @bind="_model.CategoryId">
                                <option value="">未分类</option>
                                @foreach (var c in _categories)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="admin-label">标签</label>
                            <input type="text" class="form-control" @bind="_model.Tags" placeholder="用逗号分隔，如：C#,Blazor" />
                        </div>

                        <div class="form-group" style="display:flex; flex-direction:column; gap:8px;">
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                <input type="checkbox" @bind="_model.IsPinned" />
                                <span class="admin-label" style="margin:0;">置顶</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                <input type="checkbox" @bind="_model.AllowComments" />
                                <span class="admin-label" style="margin:0;">允许评论</span>
                            </label>
                        </div>

                        <hr style="border:none; border-top:1px solid var(--border-color, #eee); margin:12px 0;" />

                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <button class="auth-submit-btn" style="padding:10px;" @onclick="() => SavePost(true)" disabled="@_isSaving" type="button">
                                @(_isSaving ? "保存中..." : "发布")
                            </button>
                            <button class="write-post-btn" style="width:100%; text-align:center;" @onclick="() => SavePost(false)" disabled="@_isSaving" type="button">
                                保存草稿
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="card fade-in" style="text-align:center; padding:60px 20px;">
            <h2>无权访问</h2>
            <p style="color:var(--text-secondary);">请使用管理员或作者账号登录后访问。</p>
            <a href="/" style="color:var(--accent-color); text-decoration:none;">&larr; 返回首页</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public int? PostId { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private bool IsNew => PostId is null or 0;

    private PostEditModel _model = new();
    private List<Category> _categories = new();
    private bool _isSaving;
    private bool _showPreview = true;
    private string? _error;
    private string? _success;
    private DateTime? _lastAutoSave;
    private int _currentUserId;
    private System.Threading.Timer? _autoSaveTimer;

    private string PreviewHtml
    {
        get
        {
            var pipeline = new MarkdownPipelineBuilder().UseAdvancedExtensions().Build();
            return Markdown.ToHtml(_model.Content ?? string.Empty, pipeline);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _categories = await BlogService.GetCategoriesAsync();

        if (AuthState != null)
        {
            var state = await AuthState;
            var idClaim = state.User.FindFirst(ClaimTypes.NameIdentifier);
            if (idClaim != null && int.TryParse(idClaim.Value, out var userId))
            {
                _currentUserId = userId;
            }
        }

        if (!IsNew)
        {
            var post = await AdminService.GetPostByIdAsync(PostId!.Value);
            if (post != null)
            {
                _model = new PostEditModel
                {
                    Title = post.Title,
                    Content = post.Content,
                    Summary = post.Summary,
                    CategoryId = post.CategoryId,
                    Tags = string.Join(", ", post.Tags),
                    IsPinned = post.IsPinned,
                    AllowComments = post.AllowComments
                };
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // 尝试从 localStorage 恢复草稿（仅新建时）
        if (IsNew)
        {
            try
            {
                var draft = await JS.InvokeAsync<string>("localStorage.getItem", "admin_draft");
                if (!string.IsNullOrWhiteSpace(draft))
                {
                    var parts = draft.Split("|||", 2);
                    if (parts.Length == 2)
                    {
                        _model.Title = parts[0];
                        _model.Content = parts[1];
                        StateHasChanged();
                    }
                }
            }
            catch { }
        }

        // 启动自动保存计时器（每30秒）
        _autoSaveTimer = new System.Threading.Timer(async _ => await AutoSaveDraft(), null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private async Task AutoSaveDraft()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_model.Title) && string.IsNullOrWhiteSpace(_model.Content))
                return;

            var data = $"{_model.Title}|||{_model.Content}";
            await JS.InvokeVoidAsync("localStorage.setItem", "admin_draft", data);
            _lastAutoSave = DateTime.Now;
            await InvokeAsync(StateHasChanged);
        }
        catch { }
    }

    private async Task SavePost(bool publish)
    {
        _error = null;
        _success = null;

        if (string.IsNullOrWhiteSpace(_model.Title))
        {
            _error = "标题不能为空。";
            return;
        }

        if (_model.Title.Trim().Length > 200)
        {
            _error = "标题不能超过200个字符。";
            return;
        }

        if (string.IsNullOrWhiteSpace(_model.Content))
        {
            _error = "内容不能为空。";
            return;
        }

        if (_currentUserId == 0)
        {
            _error = "未获取到登录用户信息，请重新登录。";
            return;
        }

        _isSaving = true;
        try
        {
            if (IsNew)
            {
                var postId = await AdminService.CreatePostAsync(
                    _currentUserId, _model.Title, _model.Content, _model.Summary,
                    _model.CategoryId, _model.Tags, publish);

                if (postId == null)
                {
                    _error = "创建失败。";
                    return;
                }

                // 清除自动保存的草稿
                try { await JS.InvokeVoidAsync("localStorage.removeItem", "admin_draft"); } catch { }

                _success = publish ? "发布成功！" : "草稿已保存！";
                await Task.Delay(500);
                Nav.NavigateTo($"/admin/edit/{postId}");
            }
            else
            {
                var ok = await AdminService.UpdatePostAsync(
                    PostId!.Value, _model.Title, _model.Content, _model.Summary,
                    _model.CategoryId, _model.Tags, publish, _model.IsPinned, _model.AllowComments);

                _success = ok ? (publish ? "已发布！" : "草稿已保存！") : null;
                _error = ok ? null : "更新失败。";
            }
        }
        catch (Exception ex)
        {
            _error = "保存失败：" + ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/admin");
    }

    public void Dispose()
    {
        _autoSaveTimer?.Dispose();
    }

    private sealed class PostEditModel
    {
        public string Title { get; set; } = string.Empty;
        public string Content { get; set; } = string.Empty;
        public string? Summary { get; set; }
        public int? CategoryId { get; set; }
        public string? Tags { get; set; }
        public bool IsPinned { get; set; }
        public bool AllowComments { get; set; } = true;
    }
}
